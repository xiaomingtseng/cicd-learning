name: 安全性掃描

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # 每天 UTC 2:00 執行
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout 程式碼
      uses: actions/checkout@v3
    
    - name: 執行 CodeQL 分析
      uses: github/codeql-action/init@v2
      with:
        languages: javascript
    
    - name: 自動建置
      uses: github/codeql-action/autobuild@v2
    
    - name: 執行 CodeQL 分析
      uses: github/codeql-action/analyze@v2
    
    - name: 掃描 npm 漏洞 (前端)
      working-directory: ./frontend
      run: |
        npm audit --audit-level=high
    
    - name: 掃描 npm 漏洞 (後端)
      working-directory: ./backend
      run: |
        npm audit --audit-level=high
    
    - name: 執行 Trivy 漏洞掃描
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: 上傳 Trivy 掃描結果
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'